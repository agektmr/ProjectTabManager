<link rel="import" href="../../bower_components/iron-behaviors/iron-control-state.html">
<link rel="import" href="../../bower_components/iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">
<link rel="import" href="../chrome-i18n/chrome-i18n.html">

<script>
var PtmProjectBehaviorImpl = {
  properties: {
    project: {
      type: Object,
      value: function() {
        return [];
      }
    },
    fields: {
      type: Array,
      value: function() {
        return [];
      }
    },
    projectId: {
      type: String,
      value: '',
      reflectToAttribute: true
    },
    projectTitle: {
      type: String,
      value: '',
      reflectToAttribute: true
    },
    expanded: {
      type: Boolean,
      value: false,
      reflectToAttribute: true
    },
    _foldIcon: {
      type: String,
      computed: '_computeFoldIcon(expanded)'
    },
    _elevation: {
      type: Number,
      computed: '_computeElevation(expanded)'
    },
    _projectLinked: {
      type: Boolean,
      computed: '_computeProjectLinked(projectId)'
    }
  },
  hostAttributes: {
    tabindex: 0
  },
  observers: [
    '_focusedChanged(receivedFocusFromKeyboard)'
  ],
  ready: function() {
    this.keyEventTarget = this;
    this.addOwnKeyBinding('left right', '_onArrow');
    this.addOwnKeyBinding('enter', 'openProject');
  },
  toggle: function(e) {
    e.stopPropagation();
    this.expanded = !this.expanded;
  },
  openProject: function(e) {
    e.stopPropagation();
    this.fire('open-clicked', {
      id: this.projectId
    });
  },
  _onArrow: function(e) {
    e.stopPropagation();
    switch (e.detail.key) {
      case 'left':
        this.expanded = false;
        break;
      case 'right':
        this.expanded = true;
        break;
    }
  },
  _focusedChanged: function(receivedFocusFromKeyboard) {
    this.focused != this.focused;
  },
  _computeElevation: function(expanded) {
    return expanded ? 2 : 0;
  },
  _computeFoldIcon: function(expanded) {
    return expanded ? 'unfold-less' : 'unfold-more';
  },
  _computeProjectLinked: function(projectId) {
    return projectId * 1 > -1 ? true : false;
  },
  _computeActive: function(winId) {
    return winId !== null;
  },
  _toggleBookmark: function(e) {
    var that = this;
    e.stopPropagation();
    var field = e.model.item;
    var index = e.model.index;
    if (field.id === undefined || field.id === '') {
      this.project.addBookmark(field.tabId).then(bookmark => {
        this.set(`fields.${index}.id`, bookmark.id);
        this.fire('show-toast', {
          text: 'Bookmark added'
        });
      });
    } else {
      this.project.removeBookmark(field.id).then(() => {
        this.set(`fields.${index}.id`, '');
        this.fire('show-toast', {
          text: 'Bookmark removed'
        });
      });
    }
  }
};

var PtmProjectBehavior = [
  PtmProjectBehaviorImpl,
  Polymer.IronControlState,
  Polymer.IronA11yKeysBehavior,
  ChromeI18n
];
</script>
